# Test info

- Name: playwright-4-multi-pdf-combinations: Critical Multi-PDF Upload Tests >> Test 1: Vendor (Rechnung) first, then Kundenbeleg (Kreditkartenbeleg)
- Location: /Users/daniel/dev/Bewritung/bewir/test/playwright-4-multi-pdf-combinations.spec.ts:129:3

# Error details

```
Error: locator.inputValue: Error: strict mode violation: getByLabel('Trinkgeld') resolved to 2 elements:
    1) <input type="text" value="2.10" inputmode="numeric" aria-invalid="false" data-path="trinkgeld" data-variant="default" id="mantine-jxecev5cc" placeholder="Trinkgeld in Euro" aria-describedby="mantine-jxecev5cc-description" class="m_8fb7ebe7 mantine-Input-input mantine-NumberInput-input"/> aka getByRole('textbox', { name: 'Trinkgeld', exact: true })
    2) <input readonly type="text" value="0.40" inputmode="numeric" aria-invalid="false" data-variant="default" id="mantine-gtc6t9bqd" data-path="trinkgeldMwst" placeholder="MwSt. in Euro" aria-describedby="mantine-gtc6t9bqd-description" class="m_8fb7ebe7 mantine-Input-input mantine-NumberInput-input"/> aka getByRole('textbox', { name: 'MwSt. Trinkgeld' })

Call log:
  - waiting for getByLabel('Trinkgeld')

    at verifyAllFieldsPopulated (/Users/daniel/dev/Bewritung/bewir/test/playwright-4-multi-pdf-combinations.spec.ts:38:56)
    at /Users/daniel/dev/Bewritung/bewir/test/playwright-4-multi-pdf-combinations.spec.ts:143:5
```

# Page snapshot

```yaml
- banner:
  - link "DocBits":
    - /url: /
    - img "DocBits"
  - link "Beleg erstellen":
    - /url: /bewirtungsbeleg
  - link "Features":
    - /url: /#features
  - link "GoBD":
    - /url: /gobd
  - link "Release Notes":
    - /url: /release-notes
  - link "Anmelden":
    - /url: /auth/anmelden
  - link "Registrieren":
    - /url: /auth/registrieren
- main:
  - img "DocBits Logo"
  - heading "Bewirtungsbeleg" [level=1]
  - checkbox "Eigenbeleg (ohne Originalbeleg)"
  - text: Eigenbeleg (ohne Originalbeleg)
  - paragraph: "Aktivieren Sie diese Option, wenn Sie keinen Originalbeleg haben. Hinweis: Bei Eigenbelegen kann die Vorsteuer (MwSt.) nicht geltend gemacht werden."
  - heading "Allgemeine Angaben" [level=2]
  - paragraph: Foto/Scan der Rechnung
  - paragraph: Laden Sie Fotos, Scans oder PDFs hoch - die Daten werden automatisch extrahiert
  - button "Choose File"
  - img
  - paragraph: Dateien hier ablegen
  - paragraph: Bilder (PNG, JPEG, WEBP) oder PDFs, max. 5 Dateien
  - paragraph: Hochgeladene Dateien (2/5)
  - img
  - paragraph: PDF
  - paragraph: 19092025_(Vendor).pdf
  - text: Rechnung 435.9 KB
  - textbox "Klassifizierung": Rechnung
  - img
  - button "Datei entfernen":
    - img
  - img
  - paragraph: PDF
  - paragraph: 19092025_* * Kundenbeleg.pdf
  - text: Kreditkartenbeleg 252.7 KB
  - textbox "Klassifizierung": Kreditkartenbeleg
  - img
  - button "Datei entfernen":
    - img
  - text: Datum der Bewirtung
  - textbox "Datum der Bewirtung": 19.09.2025
  - text: Restaurant
  - textbox "Restaurant": Osteria del Parco
  - text: Anschrift
  - textbox "Anschrift": Anzinger Strasse 1, 85586 Poing
  - text: Art der Bewirtung
  - paragraph: Wählen Sie die Art der Bewirtung - dies beeinflusst die steuerliche Abzugsfähigkeit
  - radiogroup "Art der Bewirtung":
    - radio "Kundenbewirtung (70% abzugsfähig)" [checked]
    - text: Kundenbewirtung (70% abzugsfähig)
    - paragraph: Für Geschäftsfreunde (Kunden, Geschäftspartner). 70% der Kosten sind als Betriebsausgabe abziehbar.
    - radio "Mitarbeiterbewirtung (100% abzugsfähig)"
    - text: Mitarbeiterbewirtung (100% abzugsfähig)
    - paragraph: Für betriebliche Veranstaltungen (Teamessen, Arbeitsessen). 100% der Kosten sind als Betriebsausgabe abziehbar.
  - heading "Finanzielle Details" [level=2]
  - checkbox "Ausländische Rechnung (keine MwSt.)"
  - text: Ausländische Rechnung (keine MwSt.)
  - paragraph: Aktivieren Sie diese Option, wenn die Rechnung aus dem Ausland stammt. In diesem Fall wird der Gesamtbetrag als Netto behandelt.
  - separator
  - checkbox "ZUGFeRD-kompatibles PDF generieren"
  - text: ZUGFeRD-kompatibles PDF generieren
  - paragraph: Erstellt ein elektronisches Rechnungsformat nach ZUGFeRD 2.0 Standard für die digitale Archivierung
  - text: Gesamtbetrag (Brutto)
  - paragraph: Geben Sie den Gesamtbetrag der Rechnung ein (inkl. MwSt.)
  - textbox "Gesamtbetrag (Brutto)": "53.90"
  - text: MwSt. Gesamtbetrag
  - paragraph: MwSt. (19%) wird automatisch berechnet
  - textbox "MwSt. Gesamtbetrag": "8.61"
  - text: Netto Gesamtbetrag
  - paragraph: Netto wird automatisch berechnet
  - textbox "Netto Gesamtbetrag": "45.29"
  - text: Betrag auf Kreditkarte/Bar
  - paragraph: Geben Sie den Betrag ein, der auf der Kreditkarte belastet wurde (inkl. Trinkgeld)
  - textbox "Betrag auf Kreditkarte/Bar": "56.00"
  - text: Trinkgeld
  - paragraph: Geben Sie das Trinkgeld ein. Dies wird automatisch berechnet, wenn Sie den Betrag auf der Kreditkarte eingeben
  - textbox "Trinkgeld": "2.10"
  - text: MwSt. Trinkgeld
  - paragraph: MwSt. (19%) wird automatisch berechnet
  - textbox "MwSt. Trinkgeld": "0.40"
  - text: Zahlungsart
  - paragraph: Wählen Sie die Art der Zahlung. Die Rechnung muss auf die Firma ausgestellt sein.
  - textbox "Zahlungsart": Firmenkreditkarte
  - img
  - heading "Geschäftlicher Anlass" [level=2]
  - text: Geschäftlicher Anlass
  - paragraph: Geben Sie den konkreten Anlass an (z.B. 'Kundengespräch', 'Projektbesprechung')
  - textbox "Geschäftlicher Anlass"
  - text: Namen aller Teilnehmer
  - paragraph: Geben Sie die Namen aller Teilnehmer ein (auch Ihren eigenen Namen)
  - textbox "Namen aller Teilnehmer"
  - text: Namen der Geschäftspartner
  - paragraph: Geben Sie die Namen der Geschäftspartner ein
  - textbox "Namen der Geschäftspartner"
  - text: Firma der Geschäftspartner
  - paragraph: Geben Sie die Firma der Geschäftspartner ein
  - textbox "Firma der Geschäftspartner"
  - button "JSON Download":
    - img
    - text: JSON Download
  - img
  - button "JSON Upload"
  - button "Weiter"
  - paragraph: Image Editor
  - img "Receipt preview"
  - paragraph: Rotation Controls
  - button:
    - img
  - button:
    - img
  - button:
    - img
  - button [disabled]:
    - img
  - button "Apply Rotation" [disabled]
- alert
```

# Test source

```ts
   1 | /**
   2 |  * Playwright E2E Test: Multi-PDF Upload - All 4 Combinations
   3 |  *
   4 |  * Tests all upload order combinations to ensure NO fields are ever cleared:
   5 |  * 1. Vendor (Rechnung) first, then Kundenbeleg (Kreditkartenbeleg)
   6 |  * 2. Kundenbeleg (Kreditkartenbeleg) first, then Vendor (Rechnung)
   7 |  * 3. Vendor first, wait 20 seconds, then Kundenbeleg
   8 |  * 4. Kundenbeleg first, wait 20 seconds, then Vendor
   9 |  *
   10 |  * All tests verify these fields are populated:
   11 |  * - Gesamtbetrag (Brutto)
   12 |  * - MwSt. Gesamtbetrag
   13 |  * - Netto Gesamtbetrag
   14 |  * - Betrag auf Kreditkarte/Bar
   15 |  * - Trinkgeld
   16 |  * - MwSt. Trinkgeld
   17 |  *
   18 |  * CRITICAL: This test runs before every deployment and git push
   19 |  */
   20 |
   21 | import { test, expect } from '@playwright/test';
   22 | import * as path from 'path';
   23 | import { fileURLToPath } from 'url';
   24 |
   25 | const __filename = fileURLToPath(import.meta.url);
   26 | const __dirname = path.dirname(__filename);
   27 |
   28 | // Helper function to verify all required fields are populated
   29 | async function verifyAllFieldsPopulated(page: any) {
   30 |   console.log('=== Verifying All Required Fields Are Populated ===');
   31 |
   32 |   // Use Playwright accessibility selectors for Mantine NumberInput components
   33 |   // These components are rendered as textbox roles with ARIA labels
   34 |   const gesamtbetrag = await page.getByLabel('Gesamtbetrag (Brutto)').inputValue();
   35 |   const gesamtbetragMwst = await page.getByLabel('MwSt. Gesamtbetrag').inputValue();
   36 |   const gesamtbetragNetto = await page.getByLabel('Netto Gesamtbetrag').inputValue();
   37 |   const kreditkartenBetrag = await page.getByLabel('Betrag auf Kreditkarte/Bar').inputValue();
>  38 |   const trinkgeld = await page.getByLabel('Trinkgeld').inputValue();
      |                                                        ^ Error: locator.inputValue: Error: strict mode violation: getByLabel('Trinkgeld') resolved to 2 elements:
   39 |   const trinkgeldMwst = await page.getByLabel('MwSt. Trinkgeld').inputValue();
   40 |
   41 |   console.log('Field Values:');
   42 |   console.log('  Gesamtbetrag (Brutto):', gesamtbetrag);
   43 |   console.log('  MwSt. Gesamtbetrag:', gesamtbetragMwst);
   44 |   console.log('  Netto Gesamtbetrag:', gesamtbetragNetto);
   45 |   console.log('  Betrag auf Kreditkarte/Bar:', kreditkartenBetrag);
   46 |   console.log('  Trinkgeld:', trinkgeld);
   47 |   console.log('  MwSt. Trinkgeld:', trinkgeldMwst);
   48 |
   49 |   // CRITICAL: Verify all fields have non-empty values
   50 |   // This is the KEY requirement - NO fields should EVER be cleared
   51 |   expect(gesamtbetrag, 'Gesamtbetrag (Brutto) should be populated').not.toBe('');
   52 |   expect(gesamtbetragMwst, 'MwSt. Gesamtbetrag should be populated').not.toBe('');
   53 |   expect(gesamtbetragNetto, 'Netto Gesamtbetrag should be populated').not.toBe('');
   54 |   expect(kreditkartenBetrag, 'Betrag auf Kreditkarte/Bar should be populated').not.toBe('');
   55 |   expect(trinkgeld, 'Trinkgeld should be populated').not.toBe('');
   56 |   expect(trinkgeldMwst, 'MwSt. Trinkgeld should be populated').not.toBe('');
   57 |
   58 |   // Verify values are numeric
   59 |   expect(parseFloat(gesamtbetrag), 'Gesamtbetrag should be a valid number').toBeGreaterThan(0);
   60 |   expect(parseFloat(gesamtbetragMwst), 'MwSt should be a valid number').toBeGreaterThan(0);
   61 |   expect(parseFloat(gesamtbetragNetto), 'Netto should be a valid number').toBeGreaterThan(0);
   62 |   expect(parseFloat(kreditkartenBetrag), 'Kreditkarten should be a valid number').toBeGreaterThan(0);
   63 |   expect(parseFloat(trinkgeld), 'Trinkgeld should be a valid number').toBeGreaterThan(0);
   64 |   expect(parseFloat(trinkgeldMwst), 'Trinkgeld MwSt should be a valid number').toBeGreaterThan(0);
   65 |
   66 |   console.log('✅ All fields verified successfully!');
   67 |
   68 |   return {
   69 |     gesamtbetrag,
   70 |     gesamtbetragMwst,
   71 |     gesamtbetragNetto,
   72 |     kreditkartenBetrag,
   73 |     trinkgeld,
   74 |     trinkgeldMwst
   75 |   };
   76 | }
   77 |
   78 | // Helper function to upload a file and wait for processing
   79 | async function uploadAndWaitForProcessing(page: any, filePath: string, fileType: string) {
   80 |   console.log(`=== Uploading ${fileType}: ${filePath} ===`);
   81 |
   82 |   const fileInput = page.locator('input[type="file"]').first();
   83 |   await fileInput.setInputFiles([filePath]);
   84 |
   85 |   console.log(`✓ ${fileType} uploaded`);
   86 |
   87 |   // Wait for conversion API to complete
   88 |   await page.waitForResponse(
   89 |     response => response.url().includes('/api/convert-pdf') && response.status() === 200,
   90 |     { timeout: 20000 }
   91 |   );
   92 |
   93 |   console.log(`✓ ${fileType} converted`);
   94 |
   95 |   // Wait for classification API to complete
   96 |   await page.waitForResponse(
   97 |     response => response.url().includes('/api/classify-receipt') && response.status() === 200,
   98 |     { timeout: 20000 }
   99 |   );
  100 |
  101 |   console.log(`✓ ${fileType} classified`);
  102 |
  103 |   // Wait for OCR extraction API to complete
  104 |   await page.waitForResponse(
  105 |     response => response.url().includes('/api/extract-receipt') && response.status() === 200,
  106 |     { timeout: 20000 }
  107 |   );
  108 |
  109 |   console.log(`✓ ${fileType} OCR extraction completed`);
  110 |
  111 |   // Wait a bit for UI to update
  112 |   await page.waitForTimeout(1000);
  113 | }
  114 |
  115 | test.describe('playwright-4-multi-pdf-combinations: Critical Multi-PDF Upload Tests', () => {
  116 |   const rechnungPath = path.join(__dirname, 'test-files', '19092025_(Vendor).pdf');
  117 |   const kreditkartenPath = path.join(__dirname, 'test-files', '19092025_* * Kundenbeleg.pdf');
  118 |
  119 |   // Set timeout to 2 minutes for each test (20s wait + upload processing)
  120 |   test.setTimeout(120000);
  121 |
  122 |   test.beforeEach(async ({ page }) => {
  123 |     console.log('=== Navigate to Bewirtungsbeleg Form ===');
  124 |     await page.goto('/bewirtungsbeleg');
  125 |     await page.waitForLoadState('networkidle');
  126 |     console.log('✓ Form page loaded');
  127 |   });
  128 |
  129 |   test('Test 1: Vendor (Rechnung) first, then Kundenbeleg (Kreditkartenbeleg)', async ({ page }) => {
  130 |     console.log('\n🧪 TEST 1: Vendor → Kundenbeleg (Normal Order)\n');
  131 |
  132 |     // Upload Vendor (Rechnung) first
  133 |     await uploadAndWaitForProcessing(page, rechnungPath, 'Vendor (Rechnung)');
  134 |
  135 |     // Upload Kundenbeleg (Kreditkartenbeleg) second
  136 |     await uploadAndWaitForProcessing(page, kreditkartenPath, 'Kundenbeleg (Kreditkartenbeleg)');
  137 |
  138 |     // Take screenshot for verification
```