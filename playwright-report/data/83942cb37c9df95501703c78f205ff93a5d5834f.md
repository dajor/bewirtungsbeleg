# Test info

- Name: PDF to Image Conversion >> should complete full PDF workflow with rotation
- Location: /Users/daniel/dev/Bewritung/bewir/test/pdf-conversion.spec.ts:273:3

# Error details

```
Error: expect(received).toBeTruthy()

Received: false
    at /Users/daniel/dev/Bewritung/bewir/test/pdf-conversion.spec.ts:297:62
```

# Page snapshot

```yaml
- img "DocBits Logo"
- heading "Bewirtungsbeleg" [level=1]
- checkbox "Eigenbeleg (ohne Originalbeleg)"
- text: Eigenbeleg (ohne Originalbeleg)
- paragraph: "Aktivieren Sie diese Option, wenn Sie keinen Originalbeleg haben. Hinweis: Bei Eigenbelegen kann die Vorsteuer (MwSt.) nicht geltend gemacht werden."
- heading "Allgemeine Angaben" [level=2]
- paragraph: Foto/Scan der Rechnung
- paragraph: Laden Sie Fotos, Scans oder PDFs hoch - die Daten werden automatisch extrahiert
- button "Choose File"
- img
- paragraph: Dateien hier ablegen
- paragraph: Bilder (PNG, JPEG, WEBP) oder PDFs, max. 5 Dateien
- paragraph: Hochgeladene Dateien (1/5)
- img "test-receipt.jpg"
- paragraph: test-receipt.jpg
- text: Analysiere... 120.0 KB
- button "Datei entfernen":
  - img
- text: Datum der Bewirtung
- textbox "Datum der Bewirtung"
- text: Restaurant
- textbox "Restaurant"
- button "Restaurant suchen":
  - img
- text: Anschrift
- textbox "Anschrift"
- text: Art der Bewirtung
- paragraph: Wählen Sie die Art der Bewirtung - dies beeinflusst die steuerliche Abzugsfähigkeit
- radiogroup "Art der Bewirtung":
  - radio "Kundenbewirtung (70% abzugsfähig)" [checked]
  - text: Kundenbewirtung (70% abzugsfähig)
  - paragraph: Für Geschäftsfreunde (Kunden, Geschäftspartner). 70% der Kosten sind als Betriebsausgabe abziehbar.
  - radio "Mitarbeiterbewirtung (100% abzugsfähig)"
  - text: Mitarbeiterbewirtung (100% abzugsfähig)
  - paragraph: Für betriebliche Veranstaltungen (Teamessen, Arbeitsessen). 100% der Kosten sind als Betriebsausgabe abziehbar.
- heading "Finanzielle Details" [level=2]
- checkbox "Ausländische Rechnung (keine MwSt.)"
- text: Ausländische Rechnung (keine MwSt.)
- paragraph: Aktivieren Sie diese Option, wenn die Rechnung aus dem Ausland stammt. In diesem Fall wird der Gesamtbetrag als Netto behandelt.
- separator
- checkbox "ZUGFeRD-kompatibles PDF generieren"
- text: ZUGFeRD-kompatibles PDF generieren
- paragraph: Erstellt ein elektronisches Rechnungsformat nach ZUGFeRD 2.0 Standard für die digitale Archivierung
- text: Gesamtbetrag (Brutto)
- paragraph: Geben Sie den Gesamtbetrag der Rechnung ein (inkl. MwSt.)
- textbox "Gesamtbetrag (Brutto)"
- text: MwSt. Gesamtbetrag
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Gesamtbetrag"
- text: Netto Gesamtbetrag
- paragraph: Netto wird automatisch berechnet
- textbox "Netto Gesamtbetrag"
- text: Betrag auf Kreditkarte/Bar
- paragraph: Geben Sie den Betrag ein, der auf der Kreditkarte belastet wurde (inkl. Trinkgeld)
- textbox "Betrag auf Kreditkarte/Bar"
- text: Trinkgeld
- paragraph: Geben Sie das Trinkgeld ein. Dies wird automatisch berechnet, wenn Sie den Betrag auf der Kreditkarte eingeben
- textbox "Trinkgeld"
- text: MwSt. Trinkgeld
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Trinkgeld"
- text: Zahlungsart
- paragraph: Wählen Sie die Art der Zahlung. Die Rechnung muss auf die Firma ausgestellt sein.
- textbox "Zahlungsart": Firmenkreditkarte
- img
- heading "Geschäftlicher Anlass" [level=2]
- text: Geschäftlicher Anlass
- paragraph: Geben Sie den konkreten Anlass an (z.B. 'Kundengespräch', 'Projektbesprechung')
- textbox "Geschäftlicher Anlass"
- text: Namen aller Teilnehmer
- paragraph: Geben Sie die Namen aller Teilnehmer ein (auch Ihren eigenen Namen)
- textbox "Namen aller Teilnehmer"
- text: Namen der Geschäftspartner
- paragraph: Geben Sie die Namen der Geschäftspartner ein
- textbox "Namen der Geschäftspartner"
- text: Firma der Geschäftspartner
- paragraph: Geben Sie die Firma der Geschäftspartner ein
- textbox "Firma der Geschäftspartner"
- button "JSON Download":
  - img
  - text: JSON Download
- img
- button "JSON Upload"
- button "Bewirtungsbeleg erstellen"
- paragraph: Image Editor
- img "Receipt preview"
- paragraph: Rotation Controls
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button "Apply Rotation" [disabled]
- alert
- tooltip "Rotate 90° right"
```

# Test source

```ts
  197 |     expect(errorVisible).toBeTruthy();
  198 |   });
  199 |
  200 |   test('should clear error when removing PDF file', async ({ page }) => {
  201 |     // Mock a failed PDF conversion
  202 |     await page.route('**/api/convert-pdf', route => {
  203 |       route.fulfill({
  204 |         status: 500,
  205 |         body: JSON.stringify({ error: 'Conversion failed' })
  206 |       });
  207 |     });
  208 |
  209 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  210 |     
  211 |     if (!fs.existsSync(testPdfPath)) {
  212 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  213 |       if (fs.existsSync(sourcePdf)) {
  214 |         fs.copyFileSync(sourcePdf, testPdfPath);
  215 |       } else {
  216 |         test.skip();
  217 |         return;
  218 |       }
  219 |     }
  220 |
  221 |     // Upload PDF that will fail
  222 |     await bewirtungsbelegPage.uploadFile(testPdfPath);
  223 |
  224 |     // Wait for error
  225 |     await page.waitForTimeout(2000);
  226 |     expect(await bewirtungsbelegPage.isErrorMessageVisible()).toBeTruthy();
  227 |
  228 |     // Remove file
  229 |     await bewirtungsbelegPage.removeFile();
  230 |
  231 |     // Error should be cleared
  232 |     await page.waitForTimeout(500);
  233 |     expect(await bewirtungsbelegPage.isErrorMessageVisible()).toBeFalsy();
  234 |   });
  235 |
  236 |   test('should handle PNG files without conversion', async ({ page }) => {
  237 |     // Create a test PNG file
  238 |     const testPngPath = path.join(process.cwd(), 'test', 'test-image.png');
  239 |     
  240 |     // Create a simple PNG if it doesn't exist
  241 |     if (!fs.existsSync(testPngPath)) {
  242 |       // Create a 1x1 red pixel PNG
  243 |       const pngBuffer = Buffer.from([
  244 |         0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,
  245 |         0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,
  246 |         0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
  247 |         0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
  248 |         0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,
  249 |         0x54, 0x08, 0x99, 0x63, 0xF8, 0xCF, 0xC0, 0x00,
  250 |         0x00, 0x00, 0x03, 0x00, 0x01, 0x5E, 0xF9, 0x51,
  251 |         0x36, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E,
  252 |         0x44, 0xAE, 0x42, 0x60, 0x82
  253 |       ]);
  254 |       fs.writeFileSync(testPngPath, pngBuffer);
  255 |     }
  256 |
  257 |     // Upload PNG file
  258 |     await bewirtungsbelegPage.uploadFile(testPngPath);
  259 |
  260 |     // Should NOT show "Converting PDF..." message
  261 |     const convertingMessage = page.locator('text=Converting PDF...');
  262 |     await expect(convertingMessage).not.toBeVisible({ timeout: 2000 });
  263 |
  264 |     // Image should be displayed immediately
  265 |     const isImageVisible = await bewirtungsbelegPage.isImageDisplayed();
  266 |     expect(isImageVisible).toBeTruthy();
  267 |
  268 |     // Rotation should be enabled
  269 |     const isRotateEnabled = await bewirtungsbelegPage.isRotateButtonEnabled();
  270 |     expect(isRotateEnabled).toBeTruthy();
  271 |   });
  272 |
  273 |   test('should complete full PDF workflow with rotation', async ({ page }) => {
  274 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  275 |     
  276 |     if (!fs.existsSync(testPdfPath)) {
  277 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  278 |       if (fs.existsSync(sourcePdf)) {
  279 |         fs.copyFileSync(sourcePdf, testPdfPath);
  280 |       } else {
  281 |         test.skip();
  282 |         return;
  283 |       }
  284 |     }
  285 |
  286 |     // 1. Upload PDF
  287 |     await bewirtungsbelegPage.uploadFile(testPdfPath);
  288 |
  289 |     // 2. Wait for conversion
  290 |     await bewirtungsbelegPage.waitForPdfConversion();
  291 |
  292 |     // 3. Verify image displayed
  293 |     expect(await bewirtungsbelegPage.isImageDisplayed()).toBeTruthy();
  294 |
  295 |     // 4. Rotate right
  296 |     await bewirtungsbelegPage.rotateImageRight();
> 297 |     expect(await bewirtungsbelegPage.isEditedBadgeVisible()).toBeTruthy();
      |                                                              ^ Error: expect(received).toBeTruthy()
  298 |
  299 |     // 5. Rotate left
  300 |     await bewirtungsbelegPage.rotateImageLeft();
  301 |
  302 |     // 6. Reset to original
  303 |     await bewirtungsbelegPage.resetImage();
  304 |     expect(await bewirtungsbelegPage.isEditedBadgeVisible()).toBeFalsy();
  305 |
  306 |     // 7. Verify image still displayed
  307 |     expect(await bewirtungsbelegPage.isImageDisplayed()).toBeTruthy();
  308 |   });
  309 |
  310 |   test('should not extract data from PDF files', async ({ page }) => {
  311 |     // Intercept extraction API to verify it's not called for PDFs
  312 |     let extractionCalled = false;
  313 |     await page.route('**/api/extract-receipt', route => {
  314 |       extractionCalled = true;
  315 |       route.continue();
  316 |     });
  317 |
  318 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  319 |     
  320 |     if (!fs.existsSync(testPdfPath)) {
  321 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  322 |       if (fs.existsSync(sourcePdf)) {
  323 |         fs.copyFileSync(sourcePdf, testPdfPath);
  324 |       } else {
  325 |         test.skip();
  326 |         return;
  327 |       }
  328 |     }
  329 |
  330 |     // Upload PDF
  331 |     await bewirtungsbelegPage.uploadFile(testPdfPath);
  332 |
  333 |     // Wait for conversion
  334 |     await bewirtungsbelegPage.waitForPdfConversion();
  335 |
  336 |     // Try to extract data
  337 |     const extractButton = page.locator('button:has-text("Daten extrahieren")');
  338 |     
  339 |     // Button should either be disabled or not trigger extraction for PDFs
  340 |     if (await extractButton.isVisible() && await extractButton.isEnabled()) {
  341 |       await extractButton.click();
  342 |       await page.waitForTimeout(2000);
  343 |     }
  344 |
  345 |     // Verify extraction was not called
  346 |     expect(extractionCalled).toBeFalsy();
  347 |   });
  348 | });
  349 |
  350 | test.describe('Multiple File Handling', () => {
  351 |   let bewirtungsbelegPage: BewirtungsbelegPage;
  352 |
  353 |   test.beforeEach(async ({ page }) => {
  354 |     bewirtungsbelegPage = new BewirtungsbelegPage(page);
  355 |     await bewirtungsbelegPage.navigate();
  356 |   });
  357 |
  358 |   test('should handle mixed PDF and image uploads', async ({ page }) => {
  359 |     // Create test files
  360 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  361 |     const testPngPath = path.join(process.cwd(), 'test', 'test-image.png');
  362 |     
  363 |     // Ensure PDF exists
  364 |     if (!fs.existsSync(testPdfPath)) {
  365 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  366 |       if (fs.existsSync(sourcePdf)) {
  367 |         fs.copyFileSync(sourcePdf, testPdfPath);
  368 |       } else {
  369 |         test.skip();
  370 |         return;
  371 |       }
  372 |     }
  373 |
  374 |     // Ensure PNG exists
  375 |     if (!fs.existsSync(testPngPath)) {
  376 |       const pngBuffer = Buffer.from([
  377 |         0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,
  378 |         0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,
  379 |         0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
  380 |         0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
  381 |         0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,
  382 |         0x54, 0x08, 0x99, 0x63, 0xF8, 0xCF, 0xC0, 0x00,
  383 |         0x00, 0x00, 0x03, 0x00, 0x01, 0x5E, 0xF9, 0x51,
  384 |         0x36, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E,
  385 |         0x44, 0xAE, 0x42, 0x60, 0x82
  386 |       ]);
  387 |       fs.writeFileSync(testPngPath, pngBuffer);
  388 |     }
  389 |
  390 |     // Upload both files
  391 |     const fileInput = page.locator('input[type="file"][accept*="image"], input[type="file"][accept*="pdf"]').first();
  392 |     await fileInput.setInputFiles([testPngPath, testPdfPath]);
  393 |
  394 |     // Wait for PDF conversion (PNG should be instant)
  395 |     await page.waitForTimeout(3000);
  396 |
  397 |     // Both files should be visible in the list
```