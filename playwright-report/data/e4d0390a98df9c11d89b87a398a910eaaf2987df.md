# Test info

- Name: PDF to Image Conversion >> should handle PDF conversion errors gracefully
- Location: /Users/daniel/dev/Bewritung/bewir/test/pdf-conversion.spec.ts:170:3

# Error details

```
Error: locator.isVisible: Error: strict mode violation: locator('[role="alert"]') resolved to 3 elements:
    1) <div role="alert" class="m_a513464 mantine-Notification-root">…</div> aka getByRole('alert').filter({ hasText: 'FehlerFehler bei der PDF-' })
    2) <div role="alert" data-variant="light" id="mantine-kk49v2641" class="m_66836ed3 mantine-Alert-root" aria-describedby="mantine-kk49v2641-body">…</div> aka locator('#mantine-kk49v2641')
    3) <div role="alert" aria-live="assertive" id="__next-route-announcer__"></div> aka locator('[id="__next-route-announcer__"]')

Call log:
    - checking visibility of locator('[role="alert"]')

    at BewirtungsbelegPage.isErrorMessageVisible (/Users/daniel/dev/Bewritung/bewir/test/pdf-conversion.spec.ts:80:54)
    at /Users/daniel/dev/Bewritung/bewir/test/pdf-conversion.spec.ts:198:52
```

# Page snapshot

```yaml
- img "DocBits Logo"
- alert:
  - text: "Fehler Fehler bei der PDF-Konvertierung: PDF conversion failed: PDF conversion failed: Conversion failed. Bitte füllen Sie die Felder manuell aus."
  - button:
    - img
- heading "Bewirtungsbeleg" [level=1]
- checkbox "Eigenbeleg (ohne Originalbeleg)"
- text: Eigenbeleg (ohne Originalbeleg)
- paragraph: "Aktivieren Sie diese Option, wenn Sie keinen Originalbeleg haben. Hinweis: Bei Eigenbelegen kann die Vorsteuer (MwSt.) nicht geltend gemacht werden."
- heading "Allgemeine Angaben" [level=2]
- paragraph: Foto/Scan der Rechnung
- paragraph: Laden Sie Fotos, Scans oder PDFs hoch - die Daten werden automatisch extrahiert
- button "Choose File"
- img
- paragraph: Dateien hier ablegen
- paragraph: Bilder (PNG, JPEG, WEBP) oder PDFs, max. 5 Dateien
- paragraph: Hochgeladene Dateien (1/5)
- img
- paragraph: PDF
- paragraph: test-receipt.pdf
- text: Unbekannt 210.3 KB
- textbox "Klassifizierung": Unbekannt
- img
- button "Datei entfernen":
  - img
- text: Datum der Bewirtung
- textbox "Datum der Bewirtung"
- text: Restaurant
- textbox "Restaurant"
- button "Restaurant suchen":
  - img
- text: Anschrift
- textbox "Anschrift"
- text: Art der Bewirtung
- paragraph: Wählen Sie die Art der Bewirtung - dies beeinflusst die steuerliche Abzugsfähigkeit
- radiogroup "Art der Bewirtung":
  - radio "Kundenbewirtung (70% abzugsfähig)" [checked]
  - text: Kundenbewirtung (70% abzugsfähig)
  - paragraph: Für Geschäftsfreunde (Kunden, Geschäftspartner). 70% der Kosten sind als Betriebsausgabe abziehbar.
  - radio "Mitarbeiterbewirtung (100% abzugsfähig)"
  - text: Mitarbeiterbewirtung (100% abzugsfähig)
  - paragraph: Für betriebliche Veranstaltungen (Teamessen, Arbeitsessen). 100% der Kosten sind als Betriebsausgabe abziehbar.
- heading "Finanzielle Details" [level=2]
- checkbox "Ausländische Rechnung (keine MwSt.)"
- text: Ausländische Rechnung (keine MwSt.)
- paragraph: Aktivieren Sie diese Option, wenn die Rechnung aus dem Ausland stammt. In diesem Fall wird der Gesamtbetrag als Netto behandelt.
- separator
- checkbox "ZUGFeRD-kompatibles PDF generieren"
- text: ZUGFeRD-kompatibles PDF generieren
- paragraph: Erstellt ein elektronisches Rechnungsformat nach ZUGFeRD 2.0 Standard für die digitale Archivierung
- text: Gesamtbetrag (Brutto)
- paragraph: Geben Sie den Gesamtbetrag der Rechnung ein (inkl. MwSt.)
- textbox "Gesamtbetrag (Brutto)"
- text: MwSt. Gesamtbetrag
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Gesamtbetrag"
- text: Netto Gesamtbetrag
- paragraph: Netto wird automatisch berechnet
- textbox "Netto Gesamtbetrag"
- text: Betrag auf Kreditkarte/Bar
- paragraph: Geben Sie den Betrag ein, der auf der Kreditkarte belastet wurde (inkl. Trinkgeld)
- textbox "Betrag auf Kreditkarte/Bar"
- text: Trinkgeld
- paragraph: Geben Sie das Trinkgeld ein. Dies wird automatisch berechnet, wenn Sie den Betrag auf der Kreditkarte eingeben
- textbox "Trinkgeld"
- text: MwSt. Trinkgeld
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Trinkgeld"
- text: Zahlungsart
- paragraph: Wählen Sie die Art der Zahlung. Die Rechnung muss auf die Firma ausgestellt sein.
- textbox "Zahlungsart": Firmenkreditkarte
- img
- heading "Geschäftlicher Anlass" [level=2]
- text: Geschäftlicher Anlass
- paragraph: Geben Sie den konkreten Anlass an (z.B. 'Kundengespräch', 'Projektbesprechung')
- textbox "Geschäftlicher Anlass"
- text: Namen aller Teilnehmer
- paragraph: Geben Sie die Namen aller Teilnehmer ein (auch Ihren eigenen Namen)
- textbox "Namen aller Teilnehmer"
- text: Namen der Geschäftspartner
- paragraph: Geben Sie die Namen der Geschäftspartner ein
- textbox "Namen der Geschäftspartner"
- text: Firma der Geschäftspartner
- paragraph: Geben Sie die Firma der Geschäftspartner ein
- textbox "Firma der Geschäftspartner"
- button "JSON Download":
  - img
  - text: JSON Download
- img
- button "JSON Upload"
- button "Bewirtungsbeleg erstellen"
- paragraph: Image Editor
- alert:
  - img
  - text: Failed to convert PDF. Please try with an image file.
  - button:
    - img
- img
- paragraph: No preview available
- paragraph: Rotation Controls
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button "Apply Rotation" [disabled]
- alert
```

# Test source

```ts
   1 | /**
   2 |  * E2E Playwright tests for PDF conversion functionality
   3 |  * Tests the complete flow of uploading PDFs, converting to images, and rotating
   4 |  */
   5 |
   6 | import { test, expect, Page } from '@playwright/test';
   7 | import * as path from 'path';
   8 | import * as fs from 'fs';
   9 |
   10 | // Page Object Model for BewirtungsbelegForm
   11 | class BewirtungsbelegPage {
   12 |   constructor(private page: Page) {}
   13 |
   14 |   async navigate() {
   15 |     await this.page.goto('/bewirtungsbeleg');
   16 |     await this.page.waitForLoadState('networkidle');
   17 |     // Additional wait for DOM to stabilize
   18 |     await this.page.waitForTimeout(500);
   19 |   }
   20 |
   21 |   async uploadFile(filePath: string) {
   22 |     const fileInput = this.page.locator('input[type="file"][accept*="image"], input[type="file"][accept*="pdf"]').first();
   23 |     await fileInput.setInputFiles(filePath);
   24 |   }
   25 |
   26 |   async waitForPdfConversion() {
   27 |     // Wait for "Converting PDF..." message to appear
   28 |     await expect(this.page.locator('text=Converting PDF...')).toBeVisible({ timeout: 10000 });
   29 |     
   30 |     // Wait for conversion to complete (message disappears)
   31 |     await expect(this.page.locator('text=Converting PDF...')).toBeHidden({ timeout: 30000 });
   32 |   }
   33 |
   34 |   async isImageDisplayed(): Promise<boolean> {
   35 |     const image = this.page.locator('img[alt="Receipt preview"]');
   36 |     return await image.isVisible();
   37 |   }
   38 |
   39 |   async getImageSrc(): Promise<string | null> {
   40 |     const image = this.page.locator('img[alt="Receipt preview"]');
   41 |     return await image.getAttribute('src');
   42 |   }
   43 |
   44 |   async rotateImageRight() {
   45 |     await this.page.locator('[data-testid="rotate-right-90"]').click();
   46 |     await this.page.waitForTimeout(500); // Wait for rotation animation
   47 |   }
   48 |
   49 |   async rotateImageLeft() {
   50 |     await this.page.locator('[data-testid="rotate-left-90"]').click();
   51 |     await this.page.waitForTimeout(500);
   52 |   }
   53 |
   54 |   async isRotateButtonEnabled(): Promise<boolean> {
   55 |     return await this.page.locator('[data-testid="rotate-right-90"]').isEnabled();
   56 |   }
   57 |
   58 |   async isEditedBadgeVisible(): Promise<boolean> {
   59 |     return await this.page.locator('text=Edited').isVisible();
   60 |   }
   61 |
   62 |   async resetImage() {
   63 |     await this.page.locator('[data-testid="reset-button"]').click();
   64 |   }
   65 |
   66 |   async removeFile() {
   67 |     // Click the remove button (X) on the file card
   68 |     await this.page.locator('button[aria-label*="Remove"]').first().click();
   69 |   }
   70 |
   71 |   async getErrorMessage(): Promise<string | null> {
   72 |     const errorElement = this.page.locator('[role="alert"]');
   73 |     if (await errorElement.isVisible()) {
   74 |       return await errorElement.textContent();
   75 |     }
   76 |     return null;
   77 |   }
   78 |
   79 |   async isErrorMessageVisible(): Promise<boolean> {
>  80 |     return await this.page.locator('[role="alert"]').isVisible();
      |                                                      ^ Error: locator.isVisible: Error: strict mode violation: locator('[role="alert"]') resolved to 3 elements:
   81 |   }
   82 |
   83 |   async extractData() {
   84 |     await this.page.locator('button:has-text("Daten extrahieren")').click();
   85 |   }
   86 |
   87 |   async waitForExtractionComplete() {
   88 |     // Wait for extraction to complete
   89 |     await this.page.waitForResponse(resp => 
   90 |       resp.url().includes('/api/extract-receipt') && resp.status() === 200,
   91 |       { timeout: 30000 }
   92 |     );
   93 |   }
   94 | }
   95 |
   96 | // Test Suite
   97 | test.describe('PDF to Image Conversion', () => {
   98 |   let bewirtungsbelegPage: BewirtungsbelegPage;
   99 |
  100 |   test.beforeEach(async ({ page }) => {
  101 |     bewirtungsbelegPage = new BewirtungsbelegPage(page);
  102 |     await bewirtungsbelegPage.navigate();
  103 |   });
  104 |
  105 |   test('should convert PDF to image and display it', async ({ page }) => {
  106 |     // Create a test PDF file
  107 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  108 |     
  109 |     // Check if test PDF exists, if not create a simple one
  110 |     if (!fs.existsSync(testPdfPath)) {
  111 |       console.log('Creating test PDF...');
  112 |       // Use existing PDF from test directory if available
  113 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  114 |       if (fs.existsSync(sourcePdf)) {
  115 |         fs.copyFileSync(sourcePdf, testPdfPath);
  116 |       } else {
  117 |         // Skip test if no PDF available
  118 |         test.skip();
  119 |         return;
  120 |       }
  121 |     }
  122 |
  123 |     // Upload PDF file
  124 |     await bewirtungsbelegPage.uploadFile(testPdfPath);
  125 |
  126 |     // Wait for PDF conversion
  127 |     await bewirtungsbelegPage.waitForPdfConversion();
  128 |
  129 |     // Verify image is displayed
  130 |     const isImageVisible = await bewirtungsbelegPage.isImageDisplayed();
  131 |     expect(isImageVisible).toBeTruthy();
  132 |
  133 |     // Verify image source is base64 data
  134 |     const imageSrc = await bewirtungsbelegPage.getImageSrc();
  135 |     expect(imageSrc).toBeTruthy();
  136 |     expect(imageSrc).toContain('data:image');
  137 |   });
  138 |
  139 |   test('should enable rotation controls after PDF conversion', async ({ page }) => {
  140 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  141 |     
  142 |     if (!fs.existsSync(testPdfPath)) {
  143 |       const sourcePdf = path.join(process.cwd(), 'test', '08042025_kreditbeleg_Pareo.pdf');
  144 |       if (fs.existsSync(sourcePdf)) {
  145 |         fs.copyFileSync(sourcePdf, testPdfPath);
  146 |       } else {
  147 |         test.skip();
  148 |         return;
  149 |       }
  150 |     }
  151 |
  152 |     // Upload PDF
  153 |     await bewirtungsbelegPage.uploadFile(testPdfPath);
  154 |
  155 |     // Wait for conversion
  156 |     await bewirtungsbelegPage.waitForPdfConversion();
  157 |
  158 |     // Check rotation button is enabled
  159 |     const isRotateEnabled = await bewirtungsbelegPage.isRotateButtonEnabled();
  160 |     expect(isRotateEnabled).toBeTruthy();
  161 |
  162 |     // Rotate image
  163 |     await bewirtungsbelegPage.rotateImageRight();
  164 |
  165 |     // Check edited badge appears
  166 |     const isEditedVisible = await bewirtungsbelegPage.isEditedBadgeVisible();
  167 |     expect(isEditedVisible).toBeTruthy();
  168 |   });
  169 |
  170 |   test('should handle PDF conversion errors gracefully', async ({ page }) => {
  171 |     // Mock a failed PDF conversion by intercepting the request
  172 |     await page.route('**/api/convert-pdf', route => {
  173 |       route.fulfill({
  174 |         status: 500,
  175 |         body: JSON.stringify({ error: 'Conversion failed' })
  176 |       });
  177 |     });
  178 |
  179 |     const testPdfPath = path.join(process.cwd(), 'test', 'test-receipt.pdf');
  180 |     
```