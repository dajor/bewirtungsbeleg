# Test info

- Name: ZUGFeRD PDF Generation >> should include business entertainment deductibility in ZUGFeRD
- Location: /Users/daniel/dev/Bewritung/bewir/test/e2e-zugferd.spec.ts:189:3

# Error details

```
Error: page.fill: Test timeout of 30000ms exceeded.
Call log:
  - waiting for locator('input[name="datum"]')

    at /Users/daniel/dev/Bewritung/bewir/test/e2e-zugferd.spec.ts:191:16
```

# Page snapshot

```yaml
- banner:
  - link "DocBits":
    - /url: /
    - img "DocBits"
  - link "Beleg erstellen":
    - /url: /bewirtungsbeleg
  - link "Features":
    - /url: /#features
  - link "GoBD":
    - /url: /gobd
  - link "Release Notes":
    - /url: /release-notes
  - link "Anmelden":
    - /url: /auth/signin
  - link "Registrieren":
    - /url: /auth/register
- main:
  - img "DocBits Logo"
  - heading "Bewirtungsbeleg" [level=1]
  - checkbox "Eigenbeleg (ohne Originalbeleg)"
  - text: Eigenbeleg (ohne Originalbeleg)
  - paragraph: "Aktivieren Sie diese Option, wenn Sie keinen Originalbeleg haben. Hinweis: Bei Eigenbelegen kann die Vorsteuer (MwSt.) nicht geltend gemacht werden."
  - heading "Allgemeine Angaben" [level=2]
  - paragraph: Foto/Scan der Rechnung
  - paragraph: Laden Sie Fotos, Scans oder PDFs hoch - die Daten werden automatisch extrahiert
  - button "Choose File"
  - img
  - paragraph: Dateien hier ablegen
  - paragraph: Bilder (PNG, JPEG, WEBP) oder PDFs, max. 5 Dateien
  - text: Datum der Bewirtung
  - textbox "Datum der Bewirtung"
  - text: Restaurant
  - textbox "Restaurant"
  - text: Anschrift
  - textbox "Anschrift"
  - text: Art der Bewirtung
  - paragraph: Wählen Sie die Art der Bewirtung - dies beeinflusst die steuerliche Abzugsfähigkeit
  - radiogroup "Art der Bewirtung":
    - radio "Kundenbewirtung (70% abzugsfähig)" [checked]
    - text: Kundenbewirtung (70% abzugsfähig)
    - paragraph: Für Geschäftsfreunde (Kunden, Geschäftspartner). 70% der Kosten sind als Betriebsausgabe abziehbar.
    - radio "Mitarbeiterbewirtung (100% abzugsfähig)"
    - text: Mitarbeiterbewirtung (100% abzugsfähig)
    - paragraph: Für betriebliche Veranstaltungen (Teamessen, Arbeitsessen). 100% der Kosten sind als Betriebsausgabe abziehbar.
  - heading "Finanzielle Details" [level=2]
  - checkbox "Ausländische Rechnung (keine MwSt.)"
  - text: Ausländische Rechnung (keine MwSt.)
  - paragraph: Aktivieren Sie diese Option, wenn die Rechnung aus dem Ausland stammt. In diesem Fall wird der Gesamtbetrag als Netto behandelt.
  - separator
  - checkbox "ZUGFeRD-kompatibles PDF generieren"
  - text: ZUGFeRD-kompatibles PDF generieren
  - paragraph: Erstellt ein elektronisches Rechnungsformat nach ZUGFeRD 2.0 Standard für die digitale Archivierung
  - text: Gesamtbetrag (Brutto)
  - paragraph: Geben Sie den Gesamtbetrag der Rechnung ein (inkl. MwSt.)
  - textbox "Gesamtbetrag (Brutto)"
  - text: MwSt. Gesamtbetrag
  - paragraph: MwSt. (19%) wird automatisch berechnet
  - textbox "MwSt. Gesamtbetrag"
  - text: Netto Gesamtbetrag
  - paragraph: Netto wird automatisch berechnet
  - textbox "Netto Gesamtbetrag"
  - text: Betrag auf Kreditkarte/Bar
  - paragraph: Geben Sie den Betrag ein, der auf der Kreditkarte belastet wurde (inkl. Trinkgeld)
  - textbox "Betrag auf Kreditkarte/Bar"
  - text: Trinkgeld
  - paragraph: Geben Sie das Trinkgeld ein. Dies wird automatisch berechnet, wenn Sie den Betrag auf der Kreditkarte eingeben
  - textbox "Trinkgeld"
  - text: MwSt. Trinkgeld
  - paragraph: MwSt. (19%) wird automatisch berechnet
  - textbox "MwSt. Trinkgeld"
  - text: Zahlungsart
  - paragraph: Wählen Sie die Art der Zahlung. Die Rechnung muss auf die Firma ausgestellt sein.
  - textbox "Zahlungsart": Firmenkreditkarte
  - img
  - heading "Geschäftlicher Anlass" [level=2]
  - text: Geschäftlicher Anlass
  - paragraph: Geben Sie den konkreten Anlass an (z.B. 'Kundengespräch', 'Projektbesprechung')
  - textbox "Geschäftlicher Anlass"
  - text: Namen aller Teilnehmer
  - paragraph: Geben Sie die Namen aller Teilnehmer ein (auch Ihren eigenen Namen)
  - textbox "Namen aller Teilnehmer"
  - text: Namen der Geschäftspartner
  - paragraph: Geben Sie die Namen der Geschäftspartner ein
  - textbox "Namen der Geschäftspartner"
  - text: Firma der Geschäftspartner
  - paragraph: Geben Sie die Firma der Geschäftspartner ein
  - textbox "Firma der Geschäftspartner"
  - button "JSON Download":
    - img
    - text: JSON Download
  - img
  - button "JSON Upload"
  - button "Bewirtungsbeleg erstellen"
  - button "In GoBD-Tresor speichern"
- alert
```

# Test source

```ts
   91 |     
   92 |     // Save the file for inspection
   93 |     const downloadPath = path.join(process.cwd(), 'test-results', fileName);
   94 |     await download.saveAs(downloadPath);
   95 |     
   96 |     // Verify file exists and has content
   97 |     const fileStats = fs.statSync(downloadPath);
   98 |     expect(fileStats.size).toBeGreaterThan(1000); // PDF should be at least 1KB
   99 |     
  100 |     console.log(`ZUGFeRD PDF generated: ${downloadPath} (${fileStats.size} bytes)`);
  101 |   });
  102 |
  103 |   test('should handle ZUGFeRD generation errors gracefully', async ({ page }) => {
  104 |     // Fill minimal required fields
  105 |     await page.fill('input[name="datum"]', '15.04.2024');
  106 |     await page.fill('input[name="restaurantName"]', 'Test Restaurant');
  107 |     await page.fill('textarea[name="teilnehmer"]', 'Test Person');
  108 |     await page.fill('textarea[name="anlass"]', 'Test');
  109 |     await page.fill('input[name="gesamtbetrag"]', '50,00');
  110 |     
  111 |     // Enable ZUGFeRD with incomplete data
  112 |     const zugferdCheckbox = page.locator('input[name="generateZugferd"]');
  113 |     if (await zugferdCheckbox.isVisible()) {
  114 |       await zugferdCheckbox.check();
  115 |     }
  116 |     
  117 |     // Mock the ZUGFeRD API to return an error
  118 |     await page.route('**/api/zugferd/**', route => {
  119 |       route.fulfill({
  120 |         status: 500,
  121 |         contentType: 'application/json',
  122 |         body: JSON.stringify({ error: 'ZUGFeRD service unavailable' })
  123 |       });
  124 |     });
  125 |     
  126 |     // Try to generate PDF
  127 |     const generateButton = page.locator('button:has-text("PDF generieren")');
  128 |     await generateButton.click();
  129 |     
  130 |     // Should still generate a regular PDF as fallback
  131 |     const downloadPromise = page.waitForEvent('download', { timeout: 10000 }).catch(() => null);
  132 |     const download = await downloadPromise;
  133 |     
  134 |     if (download) {
  135 |       const fileName = download.suggestedFilename();
  136 |       // Should fall back to regular PDF without 'zugferd' in name
  137 |       expect(fileName).not.toContain('zugferd');
  138 |       expect(fileName).toContain('bewirtungsbeleg');
  139 |     }
  140 |   });
  141 |
  142 |   test('should validate VAT breakdown for ZUGFeRD', async ({ page }) => {
  143 |     // Fill form with specific VAT rates
  144 |     await page.fill('input[name="datum"]', '15.04.2024');
  145 |     await page.fill('input[name="restaurantName"]', 'Test Restaurant');
  146 |     await page.fill('input[name="restaurantAnschrift"]', 'Test Straße 1');
  147 |     await page.fill('input[name="restaurantPlz"]', '12345');
  148 |     await page.fill('input[name="restaurantOrt"]', 'Test Stadt');
  149 |     
  150 |     // Amounts with different VAT rates
  151 |     await page.fill('input[name="speisen"]', '107,00'); // 100€ + 7% VAT
  152 |     await page.fill('input[name="getraenke"]', '119,00'); // 100€ + 19% VAT
  153 |     await page.fill('input[name="trinkgeld"]', '10,00'); // No VAT
  154 |     await page.fill('input[name="gesamtbetrag"]', '236,00');
  155 |     
  156 |     await page.fill('textarea[name="teilnehmer"]', 'Test Teilnehmer');
  157 |     await page.fill('textarea[name="anlass"]', 'VAT Test');
  158 |     
  159 |     // Enable ZUGFeRD
  160 |     const zugferdCheckbox = page.locator('input[name="generateZugferd"]');
  161 |     if (await zugferdCheckbox.isVisible()) {
  162 |       await zugferdCheckbox.check();
  163 |     }
  164 |     
  165 |     // Intercept the API call to verify VAT calculation
  166 |     let apiRequestData: any = null;
  167 |     await page.route('**/api/generate-pdf', async route => {
  168 |       const request = route.request();
  169 |       apiRequestData = await request.postDataJSON();
  170 |       await route.continue();
  171 |     });
  172 |     
  173 |     // Generate PDF
  174 |     const generateButton = page.locator('button:has-text("PDF generieren")');
  175 |     await generateButton.click();
  176 |     
  177 |     // Wait a bit for the request to be captured
  178 |     await page.waitForTimeout(2000);
  179 |     
  180 |     // Verify the request included ZUGFeRD flag
  181 |     if (apiRequestData) {
  182 |       expect(apiRequestData.generateZugferd).toBe(true);
  183 |       expect(apiRequestData.speisen).toBe('107,00');
  184 |       expect(apiRequestData.getraenke).toBe('119,00');
  185 |       expect(apiRequestData.trinkgeld).toBe('10,00');
  186 |     }
  187 |   });
  188 |
  189 |   test('should include business entertainment deductibility in ZUGFeRD', async ({ page }) => {
  190 |     // Test customer entertainment (70% deductible)
> 191 |     await page.fill('input[name="datum"]', '15.04.2024');
      |                ^ Error: page.fill: Test timeout of 30000ms exceeded.
  192 |     await page.fill('input[name="restaurantName"]', 'Restaurant Test');
  193 |     await page.fill('input[name="gesamtbetrag"]', '100,00');
  194 |     await page.fill('textarea[name="teilnehmer"]', 'Kunde A, Kunde B');
  195 |     await page.fill('textarea[name="anlass"]', 'Kundenakquise');
  196 |     
  197 |     await page.selectOption('select[name="bewirtungsart"]', 'kunden');
  198 |     await page.fill('input[name="geschaeftspartnerNamen"]', 'Kunde A, Kunde B');
  199 |     await page.fill('input[name="geschaeftspartnerFirma"]', 'Kunden GmbH');
  200 |     
  201 |     // Enable ZUGFeRD
  202 |     const zugferdCheckbox = page.locator('input[name="generateZugferd"]');
  203 |     if (await zugferdCheckbox.isVisible()) {
  204 |       await zugferdCheckbox.check();
  205 |     }
  206 |     
  207 |     // Generate PDF
  208 |     const downloadPromise = page.waitForEvent('download');
  209 |     const generateButton = page.locator('button:has-text("PDF generieren")');
  210 |     await generateButton.click();
  211 |     
  212 |     const download = await downloadPromise;
  213 |     const fileName = download.suggestedFilename();
  214 |     
  215 |     // Customer entertainment PDFs should indicate 70% deductibility
  216 |     expect(fileName).toContain('bewirtungsbeleg');
  217 |     
  218 |     // Now test employee entertainment (100% deductible)
  219 |     await page.selectOption('select[name="bewirtungsart"]', 'mitarbeiter');
  220 |     await page.fill('textarea[name="teilnehmer"]', 'Mitarbeiter A, Mitarbeiter B');
  221 |     await page.fill('textarea[name="anlass"]', 'Teambuilding');
  222 |     
  223 |     const downloadPromise2 = page.waitForEvent('download');
  224 |     await generateButton.click();
  225 |     
  226 |     const download2 = await downloadPromise2;
  227 |     const fileName2 = download2.suggestedFilename();
  228 |     expect(fileName2).toContain('bewirtungsbeleg');
  229 |   });
  230 | });
  231 |
  232 | test.describe('ZUGFeRD Integration Tests', () => {
  233 |   test('should properly format German addresses in ZUGFeRD XML', async ({ request }) => {
  234 |     // Direct API test for ZUGFeRD generation
  235 |     const pdfBase64 = 'JVBERi0xLjQKJeLjz9M='; // Mock PDF
  236 |     
  237 |     const response = await request.post('/api/generate-pdf', {
  238 |       data: {
  239 |         datum: new Date('2024-04-15'),
  240 |         restaurantName: 'Müller\'s Gasthof',
  241 |         restaurantAnschrift: 'Schöneberger Straße 42',
  242 |         restaurantPlz: '10115',
  243 |         restaurantOrt: 'Berlin',
  244 |         unternehmen: 'Süddeutsche GmbH & Co. KG',
  245 |         unternehmenAnschrift: 'Königsallee 1',
  246 |         unternehmenPlz: '80331',
  247 |         unternehmenOrt: 'München',
  248 |         teilnehmer: 'Herr Müller, Frau Schäfer',
  249 |         anlass: 'Geschäftsessen für Vertragsabschluss',
  250 |         speisen: '45,50',
  251 |         getraenke: '28,90',
  252 |         trinkgeld: '7,00',
  253 |         gesamtbetrag: '81,40',
  254 |         zahlungsart: 'firma',
  255 |         bewirtungsart: 'kunden',
  256 |         geschaeftspartnerNamen: 'Herr Müller',
  257 |         geschaeftspartnerFirma: 'Müller AG',
  258 |         generateZugferd: true,
  259 |         attachments: [{
  260 |           data: `data:image/png;base64,${pdfBase64}`,
  261 |           name: 'Rechnung',
  262 |           type: 'image/png'
  263 |         }]
  264 |       }
  265 |     });
  266 |     
  267 |     // Should return a PDF (even if ZUGFeRD fails, it falls back to regular PDF)
  268 |     expect(response.ok()).toBeTruthy();
  269 |     expect(response.headers()['content-type']).toContain('application/pdf');
  270 |     
  271 |     // Check for ZUGFeRD headers if successful
  272 |     const zugferdHeader = response.headers()['x-zugferd'];
  273 |     if (zugferdHeader === 'true') {
  274 |       expect(response.headers()['x-zugferd-profile']).toBe('BASIC');
  275 |     }
  276 |   });
  277 |
  278 |   test('should handle UTF-8 characters in ZUGFeRD data', async ({ request }) => {
  279 |     const response = await request.post('/api/generate-pdf', {
  280 |       data: {
  281 |         datum: new Date('2024-04-15'),
  282 |         restaurantName: 'Café Français',
  283 |         restaurantAnschrift: 'Große Freiheit 39',
  284 |         teilnehmer: 'José García, François Müller, 王明',
  285 |         anlass: 'Internationale Geschäftsbesprechung',
  286 |         gesamtbetrag: '150,00',
  287 |         zahlungsart: 'firma',
  288 |         bewirtungsart: 'kunden',
  289 |         generateZugferd: true
  290 |       }
  291 |     });
```