# Test info

- Name: Complete Bewirtungsbeleg Workflow >> should handle PDF with multiple attachments
- Location: /Users/daniel/dev/Bewritung/bewir/test/e2e-complete-workflow.spec.ts:239:3

# Error details

```
Error: locator.clear: Test timeout of 60000ms exceeded.
Call log:
  - waiting for locator('input[name="restaurantName"], textarea[name="restaurantName"]')

    at BewirtungsbelegWorkflow.fillFormField (/Users/daniel/dev/Bewritung/bewir/test/e2e-complete-workflow.spec.ts:41:17)
    at /Users/daniel/dev/Bewritung/bewir/test/e2e-complete-workflow.spec.ts:257:20
```

# Page snapshot

```yaml
- img "DocBits Logo"
- alert:
  - text: "Fehler Fehler bei der PDF-Konvertierung: PDF conversion failed: Failed to parse PDF document (line:0 col:36 offset=18): No PDF header found. Bitte füllen Sie die Felder manuell aus."
  - button:
    - img
- heading "Bewirtungsbeleg" [level=1]
- checkbox "Eigenbeleg (ohne Originalbeleg)"
- text: Eigenbeleg (ohne Originalbeleg)
- paragraph: "Aktivieren Sie diese Option, wenn Sie keinen Originalbeleg haben. Hinweis: Bei Eigenbelegen kann die Vorsteuer (MwSt.) nicht geltend gemacht werden."
- heading "Allgemeine Angaben" [level=2]
- paragraph: Foto/Scan der Rechnung
- paragraph: Laden Sie Fotos, Scans oder PDFs hoch - die Daten werden automatisch extrahiert
- button "Choose File"
- img
- paragraph: Dateien hier ablegen
- paragraph: Bilder (PNG, JPEG, WEBP) oder PDFs, max. 5 Dateien
- paragraph: Hochgeladene Dateien (2/5)
- img
- paragraph: PDF
- paragraph: rechnung.pdf
- text: Rechnung 0.0 KB
- textbox "Klassifizierung": Rechnung
- img
- button "Datei entfernen":
  - img
- img
- paragraph: PDF
- paragraph: kreditbeleg.pdf
- text: Kreditkartenbeleg 0.0 KB
- textbox "Klassifizierung": Kreditkartenbeleg
- img
- button "Datei entfernen":
  - img
- text: Datum der Bewirtung
- textbox "Datum der Bewirtung"
- text: Restaurant
- textbox "Restaurant"
- button "Restaurant suchen":
  - img
- text: Anschrift
- textbox "Anschrift"
- text: Art der Bewirtung
- paragraph: Wählen Sie die Art der Bewirtung - dies beeinflusst die steuerliche Abzugsfähigkeit
- radiogroup "Art der Bewirtung":
  - radio "Kundenbewirtung (70% abzugsfähig)" [checked]
  - text: Kundenbewirtung (70% abzugsfähig)
  - paragraph: Für Geschäftsfreunde (Kunden, Geschäftspartner). 70% der Kosten sind als Betriebsausgabe abziehbar.
  - radio "Mitarbeiterbewirtung (100% abzugsfähig)"
  - text: Mitarbeiterbewirtung (100% abzugsfähig)
  - paragraph: Für betriebliche Veranstaltungen (Teamessen, Arbeitsessen). 100% der Kosten sind als Betriebsausgabe abziehbar.
- heading "Finanzielle Details" [level=2]
- checkbox "Ausländische Rechnung (keine MwSt.)"
- text: Ausländische Rechnung (keine MwSt.)
- paragraph: Aktivieren Sie diese Option, wenn die Rechnung aus dem Ausland stammt. In diesem Fall wird der Gesamtbetrag als Netto behandelt.
- separator
- checkbox "ZUGFeRD-kompatibles PDF generieren"
- text: ZUGFeRD-kompatibles PDF generieren
- paragraph: Erstellt ein elektronisches Rechnungsformat nach ZUGFeRD 2.0 Standard für die digitale Archivierung
- text: Gesamtbetrag (Brutto)
- paragraph: Geben Sie den Gesamtbetrag der Rechnung ein (inkl. MwSt.)
- textbox "Gesamtbetrag (Brutto)"
- text: MwSt. Gesamtbetrag
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Gesamtbetrag"
- text: Netto Gesamtbetrag
- paragraph: Netto wird automatisch berechnet
- textbox "Netto Gesamtbetrag"
- text: Betrag auf Kreditkarte/Bar
- paragraph: Geben Sie den Betrag ein, der auf der Kreditkarte belastet wurde (inkl. Trinkgeld)
- textbox "Betrag auf Kreditkarte/Bar"
- text: Trinkgeld
- paragraph: Geben Sie das Trinkgeld ein. Dies wird automatisch berechnet, wenn Sie den Betrag auf der Kreditkarte eingeben
- textbox "Trinkgeld"
- text: MwSt. Trinkgeld
- paragraph: MwSt. (19%) wird automatisch berechnet
- textbox "MwSt. Trinkgeld"
- text: Zahlungsart
- paragraph: Wählen Sie die Art der Zahlung. Die Rechnung muss auf die Firma ausgestellt sein.
- textbox "Zahlungsart": Firmenkreditkarte
- img
- heading "Geschäftlicher Anlass" [level=2]
- text: Geschäftlicher Anlass
- paragraph: Geben Sie den konkreten Anlass an (z.B. 'Kundengespräch', 'Projektbesprechung')
- textbox "Geschäftlicher Anlass"
- text: Namen aller Teilnehmer
- paragraph: Geben Sie die Namen aller Teilnehmer ein (auch Ihren eigenen Namen)
- textbox "Namen aller Teilnehmer"
- text: Namen der Geschäftspartner
- paragraph: Geben Sie die Namen der Geschäftspartner ein
- textbox "Namen der Geschäftspartner"
- text: Firma der Geschäftspartner
- paragraph: Geben Sie die Firma der Geschäftspartner ein
- textbox "Firma der Geschäftspartner"
- button "JSON Download":
  - img
  - text: JSON Download
- img
- button "JSON Upload"
- button "Bewirtungsbeleg erstellen"
- paragraph: Image Editor
- alert:
  - img
  - text: Failed to convert PDF. Please try with an image file.
  - button:
    - img
- img
- paragraph: No preview available
- paragraph: Rotation Controls
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button [disabled]:
  - img
- button "Apply Rotation" [disabled]
- alert
```

# Test source

```ts
   1 | /**
   2 |  * E2E Test 1: Complete workflow (Upload→OCR→Edit→PDF)
   3 |  * Tests the entire user journey from receipt upload to PDF generation
   4 |  */
   5 |
   6 | import { test, expect, Page } from '@playwright/test';
   7 | import * as path from 'path';
   8 | import * as fs from 'fs';
   9 |
   10 | // Page Object Model for complete workflow
   11 | class BewirtungsbelegWorkflow {
   12 |   constructor(private page: Page) {}
   13 |
   14 |   async navigate() {
   15 |     await this.page.goto('/bewirtungsbeleg');
   16 |     await this.page.waitForLoadState('networkidle');
   17 |     await this.page.waitForTimeout(500);
   18 |   }
   19 |
   20 |   async uploadReceipt(filePath: string) {
   21 |     // Use more specific selector to target the main receipt upload input (not JSON upload)
   22 |     // The receipt input has accept for images/PDFs, JSON input only accepts .json
   23 |     const fileInput = this.page.locator('input[type="file"][accept*="image"], input[type="file"][accept*="pdf"]').first();
   24 |     await fileInput.setInputFiles(filePath);
   25 |     await this.page.waitForTimeout(1000);
   26 |   }
   27 |
   28 |   async clickExtractData() {
   29 |     const extractButton = this.page.locator('button:has-text("Daten extrahieren")');
   30 |     await extractButton.click();
   31 |   }
   32 |
   33 |   async waitForOCRCompletion() {
   34 |     // Wait for loading spinner to appear and disappear
   35 |     await this.page.waitForSelector('[role="progressbar"]', { state: 'visible', timeout: 5000 });
   36 |     await this.page.waitForSelector('[role="progressbar"]', { state: 'hidden', timeout: 30000 });
   37 |   }
   38 |
   39 |   async fillFormField(fieldName: string, value: string) {
   40 |     const field = this.page.locator(`input[name="${fieldName}"], textarea[name="${fieldName}"]`);
>  41 |     await field.clear();
      |                 ^ Error: locator.clear: Test timeout of 60000ms exceeded.
   42 |     await field.fill(value);
   43 |   }
   44 |
   45 |   async selectDropdown(fieldName: string, value: string) {
   46 |     const dropdown = this.page.locator(`select[name="${fieldName}"]`);
   47 |     await dropdown.selectOption(value);
   48 |   }
   49 |
   50 |   async setDate(fieldName: string, date: string) {
   51 |     // German date format DD.MM.YYYY
   52 |     const dateInput = this.page.locator(`input[name="${fieldName}"]`);
   53 |     await dateInput.clear();
   54 |     await dateInput.fill(date);
   55 |   }
   56 |
   57 |   async clickGeneratePDF() {
   58 |     const generateButton = this.page.locator('button:has-text("PDF generieren")');
   59 |     await generateButton.click();
   60 |   }
   61 |
   62 |   async waitForPDFGeneration() {
   63 |     // Wait for success message or PDF download
   64 |     await this.page.waitForSelector('[role="alert"]:has-text("erfolgreich")', { timeout: 10000 });
   65 |   }
   66 |
   67 |   async getFormValue(fieldName: string): Promise<string> {
   68 |     const field = this.page.locator(`input[name="${fieldName}"], textarea[name="${fieldName}"]`);
   69 |     return await field.inputValue();
   70 |   }
   71 |
   72 |   async hasError(): Promise<boolean> {
   73 |     const errorAlert = this.page.locator('[role="alert"][data-type="error"]');
   74 |     return await errorAlert.isVisible();
   75 |   }
   76 |
   77 |   async getErrorMessage(): Promise<string | null> {
   78 |     const errorAlert = this.page.locator('[role="alert"][data-type="error"]');
   79 |     if (await errorAlert.isVisible()) {
   80 |       return await errorAlert.textContent();
   81 |     }
   82 |     return null;
   83 |   }
   84 | }
   85 |
   86 | test.describe('Complete Bewirtungsbeleg Workflow', () => {
   87 |   let workflow: BewirtungsbelegWorkflow;
   88 |
   89 |   test.beforeEach(async ({ page }) => {
   90 |     workflow = new BewirtungsbelegWorkflow(page);
   91 |     await workflow.navigate();
   92 |   });
   93 |
   94 |   test('should complete full workflow from image upload to PDF generation', async ({ page }) => {
   95 |     // Step 1: Upload receipt image
   96 |     const testImagePath = path.join(process.cwd(), 'test', 'test-receipt.png');
   97 |     
   98 |     // Create a simple test image if it doesn't exist
   99 |     if (!fs.existsSync(testImagePath)) {
  100 |       // Create a minimal PNG file
  101 |       const pngBuffer = Buffer.from([
  102 |         0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,
  103 |         0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,
  104 |         0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
  105 |         0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
  106 |         0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,
  107 |         0x54, 0x08, 0x99, 0x63, 0xF8, 0xCF, 0xC0, 0x00,
  108 |         0x00, 0x00, 0x03, 0x00, 0x01, 0x5E, 0xF9, 0x51,
  109 |         0x36, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E,
  110 |         0x44, 0xAE, 0x42, 0x60, 0x82
  111 |       ]);
  112 |       fs.writeFileSync(testImagePath, pngBuffer);
  113 |     }
  114 |
  115 |     await workflow.uploadReceipt(testImagePath);
  116 |
  117 |     // Step 2: Extract data with OCR (mock or real)
  118 |     // Check if extract button is available
  119 |     const extractButton = page.locator('button:has-text("Daten extrahieren")');
  120 |     if (await extractButton.isVisible()) {
  121 |       await workflow.clickExtractData();
  122 |       
  123 |       // Wait for OCR to complete (or mock response)
  124 |       try {
  125 |         await workflow.waitForOCRCompletion();
  126 |       } catch (e) {
  127 |         // OCR might fail with test image, continue with manual data
  128 |         console.log('OCR extraction skipped or failed, continuing with manual data entry');
  129 |       }
  130 |     }
  131 |
  132 |     // Step 3: Fill/Edit form fields
  133 |     await workflow.fillFormField('restaurantName', 'Restaurant Mustermann');
  134 |     await workflow.fillFormField('restaurantAnschrift', 'Musterstraße 123, 12345 Berlin');
  135 |     await workflow.setDate('datum', '06.08.2025');
  136 |     await workflow.fillFormField('teilnehmer', 'Max Mustermann, Erika Musterfrau');
  137 |     await workflow.fillFormField('anlass', 'Geschäftsessen - Projektbesprechung');
  138 |     await workflow.fillFormField('gesamtbetrag', '119,00'); // German decimal format
  139 |     
  140 |     // Select payment type and entertainment type
  141 |     await workflow.selectDropdown('zahlungsart', 'firma');
```